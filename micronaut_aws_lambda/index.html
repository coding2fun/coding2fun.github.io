<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Micronaut and AWS Lambda - Coding is Fun</title><meta name="Description" content=""><meta property="og:title" content="Micronaut and AWS Lambda" />
<meta property="og:description" content="Introduction A year ago, I was developing an enterprise solution using aws lambda with Java and at that time there was no support for high level tools and frameworks in the ecosystem with respect to Serverless space something like Spring Boot. I’ve used spring cloud in aws lambda but it didn’t work for the solution we are building. So I’ve started developing with the plain AWS SDK library and Speedment ORM but after building the few services I&rsquo;ve felt a couple of bottlenecks." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://coding2fun.github.io/micronaut_aws_lambda/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-24T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Micronaut and AWS Lambda"/>
<meta name="twitter:description" content="Introduction A year ago, I was developing an enterprise solution using aws lambda with Java and at that time there was no support for high level tools and frameworks in the ecosystem with respect to Serverless space something like Spring Boot. I’ve used spring cloud in aws lambda but it didn’t work for the solution we are building. So I’ve started developing with the plain AWS SDK library and Speedment ORM but after building the few services I&rsquo;ve felt a couple of bottlenecks."/>
<meta name="application-name" content="Coding2fun">
<meta name="apple-mobile-web-app-title" content="Coding2fun"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://coding2fun.github.io/micronaut_aws_lambda/" /><link rel="prev" href="https://coding2fun.github.io/probability-ds/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Micronaut and AWS Lambda",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/coding2fun.github.io\/micronaut_aws_lambda\/"
        },"genre": "posts","keywords": "aws, aws-lambda, micronaut","wordcount":  1485 ,
        "url": "https:\/\/coding2fun.github.io\/micronaut_aws_lambda\/","datePublished": "2020-11-24T00:00:00+00:00","dateModified": "2020-11-24T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Kishore Karunakaran"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Coding is Fun"><span class="header-title-pre"><i class='far fa-meh-blank fa-fw'></i></span>Coding is Fun</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Coding is Fun"><span class="header-title-pre"><i class='far fa-meh-blank fa-fw'></i></span>Coding is Fun</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Micronaut and AWS Lambda</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Kishore Karunakaran</a></span>&nbsp;<span class="post-category">included in <a href="/categories/java/"><i class="far fa-folder fa-fw"></i>java</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-11-24">2020-11-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1485 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;7 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#code-examples-and-numbers">Code Examples and Numbers</a></li>
        <li><a href="#choose-how-lambda-is-triggered">Choose How Lambda is Triggered</a></li>
        <li><a href="#lambda-handlers">Lambda Handlers</a></li>
        <li><a href="#database-table-and-entities">Database Table and Entities</a>
          <ul>
            <li><a href="#post-entity">Post Entity</a></li>
            <li><a href="#tag-entity">Tag Entity</a></li>
            <li><a href="#defining-the-repositories">Defining the Repositories</a></li>
            <li><a href="#controller">Controller</a></li>
          </ul>
        </li>
        <li><a href="#native-image">Native Image</a></li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#caveats">Caveats</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><br /></p>
<h3 id="introduction">Introduction</h3>
<p>A year ago, I was developing an enterprise solution using aws lambda with Java and at that time there was no support for high level tools and frameworks in the ecosystem with respect to Serverless space something like Spring Boot. I’ve used spring cloud in aws lambda but it didn’t work for the solution we are building. So I’ve started developing with the plain <a href="https://aws.amazon.com/sdk-for-java/" target="_blank" rel="noopener noreffer">AWS SDK</a> library and <a href="https://speedment.com/open-source/" target="_blank" rel="noopener noreffer">Speedment ORM</a> but after building the few services I&rsquo;ve felt a couple of bottlenecks.</p>
<ul>
<li>
<p>We need to encode and decode every request and response in each service</p>
</li>
<li>
<p>Everytime when we add a new table or edit/modify any of the schemas we need to regenerate our entity classes via the speedment UI tool.</p>
</li>
<li>
<p>We need to write many if and else statements to route the specific API endpoints to the corresponding service.</p>
</li>
<li>
<p>Sometimes speedment open source ORM generated SQL queries are not optimized thus takes longer time in querying data.</p>
</li>
<li>
<p>Lambda Cold Start Issue - A cold start happens when you execute an inactive Lambda function. The execution of an inactive Lambda function happens when there are no available containers, and the function needs to start up a new one and this takes 4-5 seconds. You can learn more about lambda cold start in this <a href="https://mikhail.io/serverless/coldstarts/aws/" target="_blank" rel="noopener noreffer">post</a>. </p>
</li>
</ul>
<p>In the late last year and early this year, two frameworks Micronaut and Quarkus came to the light which supports Serverless space in the Java ecosystem. Micronaut is inspired from spring but there is no runtime penalty for holding metadata for configuration and dependency injection. Every information is handled at compile time using AST processors.</p>
<p><br /></p>
<h3 id="code-examples-and-numbers">Code Examples and Numbers</h3>
<p>This article is accompanied by a working code example on <a href="https://github.com/khekrn/coding2fun/tree/master/Micronaut-AWS-Lambda" target="_blank" rel="noopener noreffer"><strong>GitHub</strong></a>.</p>
<table><tbody><tr><td class="has-text-align-center" data-align="center"><strong>Type</strong></td><td class="has-text-align-center" data-align="center"><strong>Memory(In MB)</strong></td><td class="has-text-align-center" data-align="center"><strong>Startup Time</strong></td><td class="has-text-align-center" data-align="center"><strong>Package Size(In MB)</strong></td></tr><tr><td class="has-text-align-center" data-align="center">Micronaut Lambda</td><td class="has-text-align-center" data-align="center">2304</td><td class="has-text-align-center" data-align="center">7 s</td><td class="has-text-align-center" data-align="center">31</td></tr><tr><td class="has-text-align-center" data-align="center">Micronaut Lambda Native Image</td><td class="has-text-align-center" data-align="center">2304</td><td class="has-text-align-center" data-align="center">907 ms</td><td class="has-text-align-center" data-align="center">26</td></tr></tbody></table>
<p>To show case the productivity of the micronaut we are going to build a minimal blog post api using Micronaut, AWS Lambda and Postgres RDS.</p>
<p><br /></p>
<h3 id="choose-how-lambda-is-triggered">Choose How Lambda is Triggered</h3>
<p>To generate the micronaut module naviage to <a href="https://micronaut.io/launch/" target="_blank" rel="noopener noreffer">https://micronaut.io/launch/</a> and select application type as <strong>Application</strong> with the following features</p>
<ul>
<li>postgres</li>
<li>data-jpa</li>
<li>aws-lambda</li>
</ul>
<p>Now generate the project and import in IDE.</p>
<p>The Micronaut application type you select depends on the triggers you want to support. To respond to incoming HTTP requests (e.g. AWS Lambda Proxy integrations in API Gateway), you can choose either Application or Serverless Function. For other triggers, such as consuming events from a queue or running on a schedule, choose Serverless Function.</p>
<table><tbody><tr><td class="has-text-align-center" data-align="center"><strong>Application Type</strong></td><td class="has-text-align-center" data-align="center"><strong>Trigger Type</strong></td></tr><tr><td class="has-text-align-center" data-align="center">Application or Serverless Function</td><td class="has-text-align-center" data-align="center">HTTP requests to a single endpoint</td></tr><tr><td class="has-text-align-center" data-align="center">Application</td><td class="has-text-align-center" data-align="center">HTTP requests to multiple endpoints</td></tr><tr><td class="has-text-align-center" data-align="center">Serverless Function</td><td class="has-text-align-center" data-align="center">S3 events, events for a queue, schedule triggers etc.</td></tr></tbody></table>
<p><br /></p>
<h3 id="lambda-handlers">Lambda Handlers</h3>
<p>Lambda function&rsquo;s handler is the method in your function code that processes events. When your function is invoked, Lambda runs the handler method. When the handler exits or returns a response, it becomes available to handle another event. The aws-lambda-java-core library defines two interfaces for handler methods. When coding your functions with Micronaut, you don&rsquo;t implement those interfaces directly. Instead, you extend or use its Micronaut equivalents.</p>
<table><tbody><tr><td class="has-text-align-center" data-align="center"><strong>Application Type</strong></td><td class="has-text-align-center" data-align="center"><strong>AWS Handler Interface</strong></td><td class="has-text-align-center" data-align="center"><strong>Micronaut Handler Class</strong></td></tr><tr><td class="has-text-align-center" data-align="center">Serverless Function</td><td class="has-text-align-center" data-align="center"><a href="https://github.com/aws/aws-lambda-java-libs/blob/master/aws-lambda-java-core/src/main/java/com/amazonaws/services/lambda/runtime/RequestHandler.java" target="_blank" rel="noreferrer noopener">RequestHandler</a></td><td class="has-text-align-center" data-align="center"><a href="https://micronaut-projects.github.io/micronaut-aws/latest/api/io/micronaut/function/aws/MicronautRequestHandler.html">MicronautRequestHandler</a></td></tr><tr><td class="has-text-align-center" data-align="center">Serverless Function</td><td class="has-text-align-center" data-align="center"><a href="https://github.com/aws/aws-lambda-java-libs/blob/master/aws-lambda-java-core/src/main/java/com/amazonaws/services/lambda/runtime/RequestStreamHandler.java">RequestStreamHandler</a></td><td class="has-text-align-center" data-align="center"><a href="https://micronaut-projects.github.io/micronaut-aws/latest/api/io/micronaut/function/aws/MicronautRequestStreamHandler.html">MicronautRequestStreamHandler</a></td></tr><tr><td class="has-text-align-center" data-align="center">Application</td><td class="has-text-align-center" data-align="center">RequestStreamHandler &lt; AwsProxyRequest , AwsProxyResponse &gt;</td><td class="has-text-align-center" data-align="center"><a href="https://micronaut-projects.github.io/micronaut-aws/latest/api/io/micronaut/function/aws/proxy/MicronautLambdaHandler.html">MicronautLambdaHandler</a></td></tr></tbody></table>
<p>You can read more about <a href="https://micronaut.io/blog/2020-08-31-micronaut-2-aws-lambda.html" target="_blank" rel="noopener noreffer">aws lambda guide in the micronaut page</a>.</p>
<p><br /></p>
<h3 id="database-table-and-entities">Database Table and Entities</h3>
<p>Consider the following tables where <strong><em>posts</em></strong> and <strong><em>tags</em></strong> exhibit a many-to-many relationship between each other. The many-to-many relationship is implemented using a third table called <strong><em>post_tags</em></strong> which contains the details of posts and their associated tags.</p>
<h4 id="post-entity">Post Entity</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;post&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;posted_at&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">postedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;last_updated_at&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastUpdatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;post_tags&#34;</span><span class="o">,</span> <span class="n">joinColumns</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;post_id&#34;</span><span class="o">)},</span>
            <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;tag_id&#34;</span><span class="o">)})</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Tag</span><span class="o">&gt;</span> <span class="n">tags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">Post</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Post</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="tag-entity">Tag Entity</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;tags&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tag</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&#34;tags&#34;</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span> <span class="n">posts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">Tag</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Tag</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="defining-the-repositories">Defining the Repositories</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PostRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;select * from post where id in(select distinct(post_tags.post_id) &#34;</span> <span class="o">+</span>
            <span class="s">&#34;from post_tags where post_tags.tag_id in(:id))&#34;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;</span> <span class="nf">filterByTag</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TagRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Tag</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">&#34;Select t.id from Tag t where t.name in(:names)&#34;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><br /></p>
<h4 id="controller">Controller</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span><span class="o">(</span><span class="s">&#34;/v1&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostTagController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PostTagService</span> <span class="n">postTagService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">PostTagController</span><span class="o">(</span><span class="n">PostTagService</span> <span class="n">postTagService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">postTagService</span> <span class="o">=</span> <span class="n">postTagService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Post</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/new-post&#34;</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION</span><span class="err">\</span><span class="n">_JSON</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Response</span><span class="o">&lt;</span><span class="n">CreatePostResponse</span><span class="o">&gt;</span> <span class="nf">createPost</span><span class="o">(</span><span class="nd">@Body</span> <span class="n">CreatePostRequest</span> <span class="n">createPostRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;In createPost&#34;</span><span class="o">);</span>

        <span class="n">var</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Response</span><span class="o">&lt;</span><span class="n">CreatePostResponse</span><span class="o">&gt;();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">var</span> <span class="n">apiResponse</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">postTagService</span><span class="o">.</span><span class="na">createPost</span><span class="o">(</span><span class="n">createPostRequest</span><span class="o">);</span>
            <span class="n">updateResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">apiResponse</span><span class="o">,</span> <span class="s">&#34;200&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BlogException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Error while creating post - &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">updateResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&#34;500&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Return from createPost&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Get</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/list-tags&#34;</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION</span><span class="err">\</span><span class="n">_JSON</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Response</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">listTags</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;In listTags&#34;</span><span class="o">);</span>

        <span class="n">var</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Response</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">var</span> <span class="n">apiResponse</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">postTagService</span><span class="o">.</span><span class="na">listTags</span><span class="o">();</span>
            <span class="n">updateResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">apiResponse</span><span class="o">,</span> <span class="s">&#34;200&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BlogException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Error while fetching post - &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">updateResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&#34;500&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Return from listTags&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><br /></p>
<p>This feels very similar to spring boot and it&rsquo;s more productive than before. Once you have the service ready you can deploy with few steps.</p>
<p>Build the package with <code>mvn clean package</code> and deploy the Jar from target folder.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/image.png"
        data-srcset="/images/image.png, /images/image.png 1.5x, /images/image.png 2x"
        data-sizes="auto"
        alt="/images/image.png"
        title="image alt text" /></p>
<p><br /></p>
<p>Define the handler with <strong>com.blog.handler.BlogHandler</strong> which is a custom class that extends <a href="https://micronaut-projects.github.io/micronaut-aws/2.0.x/api/io/micronaut/function/aws/proxy/MicronautLambdaHandler.html" target="_blank" rel="noopener noreffer">MicronautLambdaHandler.</a> If you choose not to define a custom handler, then we can set default <a href="https://micronaut-projects.github.io/micronaut-aws/2.0.x/api/io/micronaut/function/aws/proxy/MicronautLambdaHandler.html" target="_blank" rel="noopener noreffer">MicronautLambdaHandler</a> using <strong>io.micronaut.function.aws.proxy.MicronautLambdaHandler</strong> in the aws lambda.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/micronautjpa.png"
        data-srcset="/images/micronautjpa.png, /images/micronautjpa.png 1.5x, /images/micronautjpa.png 2x"
        data-sizes="auto"
        alt="/images/micronautjpa.png"
        title="image alt text" /></p>
<p><br /></p>
<p>As you can see in the above image, it takes around nearly 7 seconds to initialize the lambda which means during cold starts it will take a minimum of 7 seconds to load our application. There are plenty of approaches to improve the cold start but here we will use native images to improve our cold start time.</p>
<p><br /></p>
<h3 id="native-image">Native Image</h3>
<p>It&rsquo;s an AOT compiler for Java code to a standalone executable, called a native image. This executable includes the application classes, classes from its dependencies, runtime library classes, and statically linked native code from JDK. It does not run on the Java VM, but includes necessary components like memory management, thread scheduling, and so on from a different runtime system, called “Substrate VM”. Substrate VM is the name for the runtime components (like the deoptimizer, garbage collector, thread scheduling etc.). The resulting program has faster startup time and lower runtime memory overhead compared to a JVM.</p>
<p><br /></p>
<h3 id="installation">Installation</h3>
<ul>
<li>Install graalvm(Latest Version 20.3) using <a href="https://sdkman.io/" target="_blank" rel="noopener noreffer">SDKMAN</a> using <code>sdk install java 20.3.0.r11-grl</code>.</li>
<li>Set the default java version as graalvm 20.3 using <code>sdk default java 20.3.0.r11-grl</code>.</li>
<li>Finally, install native-image using command <code>gu install native-image</code>.</li>
</ul>
<p>In order to generate native image module, we need to choose two more features when generating micronaut module via <a href="https://micronaut.io/launch/" target="_blank" rel="noopener noreffer">https://micronaut.io/launch/</a></p>
<ul>
<li>aws-lambda-custom-runtime</li>
<li>graalvm</li>
</ul>
<p>Once you create the native module, You can define the same entities, repositories and controller components as mentioned above. To create native image</p>
<ul>
<li>Package the module using the <code>mvn clean package</code>. This will generate the target jar.</li>
<li>Use native-image tool to build native image using <code>native-image -cp target/graal-wordpress--*.jar</code>.</li>
<li>Finally package the native image to deploy in aws lambda
<ul>
<li><code>chmod 777 bootstrap</code></li>
<li><code>chmod 777 graal-wordpress</code></li>
<li><code>zip -j function.zip bootstrap pg-graal-wordpress</code></li>
</ul>
</li>
<li>Define <strong>io.micronaut.function.aws.proxy.MicronautLambdaHandler</strong> in the aws lambda as handler.</li>
</ul>
<p>When you deploy native image in AWS Lambda, we need to choose custom runtime as shown below and upload the ZIP file.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/image-1.png"
        data-srcset="/images/image-1.png, /images/image-1.png 1.5x, /images/image-1.png 2x"
        data-sizes="auto"
        alt="/images/image-1.png"
        title="image alt text" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/native-1.png"
        data-srcset="/images/native-1.png, /images/native-1.png 1.5x, /images/native-1.png 2x"
        data-sizes="auto"
        alt="/images/native-1.png"
        title="image alt text" /></p>
<p>With native image we can see the initialization is less than one second(907ms). We have reduced our cold start time from 7 seconds to nearly 1 second.</p>
<p><br /></p>
<h3 id="caveats">Caveats</h3>
<ul>
<li>Micronaut graal native image for <a href="https://github.com/micronaut-projects/micronaut-sql/issues/369" target="_blank" rel="noopener noreffer">MySQL is not stable</a> at this time(This is fixed).</li>
<li>Not all java libraries are directly supported with native images.</li>
<li>The build time of the native image will take approximately 5-6 minutes depends on your machine.</li>
</ul>
<p><br /></p>
<h3 id="conclusion">Conclusion</h3>
<ul>
<li>Micronaut and Graal VM are game changer for Java especially in the Serverless space.</li>
<li>Micronaut helps you to become more productive when building API’s using AWS Lambda or any other serverless technologies.</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-11-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://coding2fun.github.io/micronaut_aws_lambda/" data-title="Micronaut and AWS Lambda" data-via="itzkhekrn" data-hashtags="aws,aws-lambda,micronaut"><i class="fab fa-twitter fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/aws/">aws</a>,&nbsp;<a href="/tags/aws-lambda/">aws-lambda</a>,&nbsp;<a href="/tags/micronaut/">micronaut</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/probability-ds/" class="prev" rel="prev" title="Probabilistic Data Structures"><i class="fas fa-angle-left fa-fw"></i>Probabilistic Data Structures</a></div>
</div>
<div id="comments"></div></article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
